#!/usr/bin/env ruby
# frozen_string_literal: true

# Helpers
# ------------------------------------------------------------------------------
# It's helpful to know what messages came from this script,
# so we'll use log instead of `puts`
LOG_PREFIX = "\e[34m[ bin/setup ]\e[0m"
def log(message)
  puts "#{LOG_PREFIX} #{message}"
end

# We don't want the setup method to have to do all this error checking,
# and we also want to explicitly log what we are executing.
# Thus, we use this method instead of Kernel#system
def system!(*args)
  return if system(*args)

  args_output = "\e[33m#{args}\e[0m"
  log "#{args_output} failed"
  abort
end

# Setup methods
# ------------------------------------------------------------------------------
def setup
  log "Installing gems"

  # Install bundler it it's missing but don't attempt
  # to upgrade already existing version
  system! "gem install bundler --conservative"

  # Only do bundle install if the much-faster bundle check
  # indicates we need to
  system! "bundle check || bundle install"

  log "Installing JS packages"
  system! "yarn"

  log "Dropping & recreating the development & test databases"
  system! "bin/rails db:reset"

  log "Setup test environment for parallel testing"
  system! "bin/rails parallel:prepare"

  log "Compile assets"
  # Compile assets in case they were missing.
  # They are required to start the test suite
  system! "yarn build:css"
  system! "yarn build:js"

  log "Removing old logs and tempfiles"
  system! "bin/rails log:clear tmp:clear"

  log ""
  log "All set up."
  log ""
  log "Now you're ready to start with these useful commands:"
  useful_commands
end

def setup_mailcatcher
  log "Install mailcatcher"

  return if system("gem install mailcatcher --pre")

  log "Failed to install mailcatcher"

  if system("command -v brew &> /dev/null")
    log "Homebrew detected"
    log "Retry with option: --with-openssl-dir=$(brew --prefix openssl@1.1)"
    return if system("gem install mailcatcher --pre -- --with-openssl-dir=$(brew --prefix openssl@1.1)")

    log "Failed to install mailcatcher"
  end

  log "Read more about potential issues:"
  log " . https://github.com/eventmachine/eventmachine/issues/936"
  log " . https://github.com/sj26/mailcatcher#rvm"
  log " . https://github.com/sj26/mailcatcher#ruby"
end

def help
  log "Useful commands:"
  useful_commands
end

def useful_commands
  log ""
  log "  bin/dev"
  log "     # Run the app locally"
  log ""
  log "  bin/ci"
  log "     # Runs all tests and checks as CI would"
  log ""
  log "  bin/ci help"
  log "     # Show more options about how to run tests and CI"
  log ""
  log "  bin/setup mailcatcher"
  log "     # Install mailcatcher"
  log ""
  log "  bin/setup help"
  log "     # Show this help"
  log ""
end

if ARGV[0].nil?
  setup
elsif ARGV[0] == "mailcatcher"
  setup_mailcatcher
else
  help
end
