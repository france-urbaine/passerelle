#!/usr/bin/env ruby
# frozen_string_literal: true

# Helpers
# ------------------------------------------------------------------------------
# It's helpful to know what messages came from this script,
# so we'll use log instead of `puts`
LOG_PREFIX = "\e[34m[ bin/setup ]\e[0m"
def log(message)
  puts "#{LOG_PREFIX} #{message}"
end

# We don't want the setup method to have to do all this error checking,
# and we also want to explicitly log what we are executing.
# Thus, we use this method instead of Kernel#system
def system!(*args)
  return if system(*args)

  args_output = "\e[33m#{args}\e[0m"
  log "#{args_output} failed"
  abort
end

# Setup methods
# ------------------------------------------------------------------------------
def setup
  log "Installing gems"

  # Install bundler it it's missing but don't attempt
  # to upgrade already existing version
  system! "gem install bundler --conservative"

  # Only do bundle install if the much-faster bundle check
  # indicates we need to
  system! "bundle check || bundle install"

  log "Installing JS packages"
  system! "yarn"

  log "Dropping & recreating the development & test databases"
  # Note that the very first time this runs, db:reset will fail,
  # but this failure is fixed by doing a db:migrate
  system! "bin/rails db:reset || bin/rails db:prepare"

  log "Setup test environment for parallel testing"
  system! "bin/rails parallel:prepare"

  log "Compile assets"
  # Compile assets in case they were missing.
  # They are required to start the test suite
  system! "yarn build:css"
  system! "yarn build:js"

  log "Removing old logs and tempfiles"
  system! "bin/rails log:clear tmp:clear"

  log ""
  log "All set up."
  log ""
  log "To see commonly-needed commands, run:"
  log ""
  log "    bin/setup help"
  log ""
end

def help
  log "Useful commands:"
  log ""
  log "  bin/dev"
  log "     # run app locally"
  log ""
  log "  bin/ci"
  log "     # runs all tests and checks as CI would"
  log ""
  log "  bin/ci help"
  log "     # show more options about CI"
  log ""
  log "  bin/setup help"
  log "     # show this help"
  log ""
end

if ARGV[0].nil?
  setup
else
  help
end
